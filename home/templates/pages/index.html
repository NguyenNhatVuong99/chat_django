{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- <script type="text/javascript" src="{% static 'js/index.js' %}"></script> -->
</head>

<body>
    <div class="app">
        <div class="header">
            <div class="logo">
                <img src="{% static 'images/logo.jpg' %}" alt="">
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Search..." />
            </div>
            <div class="user-settings">
                <div class="">
                    <button class="detail-button">
                        <i style="cursor: pointer;" class="fa fa-sign-out" aria-hidden="true" id="btnLogout"></i>
                    </button>
                </div>

                <img class="user-profile" data-user_id id="user-avatar" src="" alt="" class="account-profile" alt="">
                <p id="full_name"></p>
            </div>
        </div>
        <div class="wrapper">
            <div class="conversation-area">
                <button class="add"></button>
                <div class="overlay"></div>
            </div>
            <div class="chat-area" data-conversation_id="" style="overflow-y: auto; height: auto; max-height:615px">
                <div class="chat-area-header">
                    <div class="chat-area-title"></div>
                    <div class="chat-area-group">
                        <img class="chat-area-profile"
                            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSkPNpVyCfLq4Ojgvjb5cQppb0DtLAcopVaQmgTikpKpA&s"
                            alt="" />
                    </div>
                </div>
                <div class="chat-area-main">

                </div>
                <div class="chat-area-footer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video">
                        <path d="M23 7l-7 5 7 5V7z" />
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <circle cx="8.5" cy="8.5" r="1.5" />
                        <path d="M21 15l-5-5L5 21" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-plus-circle">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 8v8M8 12h8" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-paperclip">
                        <path
                            d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" />
                    </svg>
                    <input type="text" placeholder="Type something here..." id="input-text" />
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-smile">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-thumbs-up">
                        <path
                            d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3" />
                    </svg>
                </div>
            </div>
            <div class="detail-area">
                <div class="detail-area-header">
                    <div class="msg-profile group">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                            <path d="M12 2l10 6.5v7L12 22 2 15.5v-7L12 2zM12 22v-6.5" />
                            <path d="M22 8.5l-10 7-10-7" />
                            <path d="M2 15.5l10-7 10 7M12 2v6.5" />
                        </svg>
                    </div>
                    <div class="detail-title">CodePen Group</div>
                    <div class="detail-subtitle">Created by Aysenur, 1 May 2020</div>
                    <div class="detail-buttons">
                        <button class="detail-button">
                            <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-phone">
                                <path
                                    d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z" />
                            </svg>
                            Call Group
                        </button>
                        <button class="detail-button">
                            <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-video">
                                <path d="M23 7l-7 5 7 5V7z" />
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                            </svg>
                            Video Chat
                        </button>
                    </div>
                </div>
                <div class="detail-changes">
                    <input type="text" placeholder="Search in Conversation">
                    <div class="detail-change">
                        Change Color
                        <div class="colors">
                            <div class="color blue selected" data-color="blue"></div>
                            <div class="color purple" data-color="purple"></div>
                            <div class="color green" data-color="green"></div>
                            <div class="color orange" data-color="orange"></div>
                        </div>
                    </div>
                    <div class="detail-change">
                        Change Emoji
                        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-thumbs-up">
                            <path
                                d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3" />
                        </svg>
                    </div>
                </div>
                <div class="detail-photos">
                    <div class="detail-photo-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-image">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <path d="M21 15l-5-5L5 21" />
                        </svg>
                        Shared photos
                    </div>
                    <div class="detail-photo-grid">
                        <img
                            src="https://images.unsplash.com/photo-1523049673857-eb18f1d7b578?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2168&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1516085216930-c93a002a8b01?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2250&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1458819714733-e5ab3d536722?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=933&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1520013817300-1f4c1cb245ef?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2287&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2247&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1559181567-c3190ca9959b?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1300&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1560393464-5c69a73c5770?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1301&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1506619216599-9d16d0903dfd?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2249&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1481349518771-20055b2a7b24?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2309&q=80" />

                        <img
                            src="https://images.unsplash.com/photo-1473170611423-22489201d919?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2251&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1579613832111-ac7dfcc7723f?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2250&q=80" />
                        <img
                            src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2189&q=80" />
                    </div>
                    <div class="view-more">View More</div>
                </div>
                <a href="https://twitter.com/AysnrTrkk" class="follow-me" target="_blank">
                    <span class="follow-text">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                            <path
                                d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
                            </path>
                        </svg>
                        Follow me on Twitter
                    </span>
                    <span class="developer">
                        <img src="https://pbs.twimg.com/profile_images/1253782473953157124/x56UURmt_400x400.jpg" />
                        Aysenur Turk — @AysnrTrkk
                    </span>
                </a>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.5/js.cookie.min.js"
        integrity="sha512-nlp9/l96/EpjYBx7EP7pGASVXNe80hGhYAUrjeXnu/fyF5Py0/RXav4BBNs7n5Hx1WFhOEOWSAVjGeC3oKxDVQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <script>
        let accessToken = sessionStorage.getItem("accessToken");
        let refreshToken = sessionStorage.getItem("refreshToken");
        let currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
        if (!accessToken || !refreshToken) {
            window.location.href = `http://127.0.0.1:8080/login`;
        }
        $(".user-profile").attr('data-user_id', currentUser.id)
        $('#user-avatar').attr('src', 'https://firebasestorage.googleapis.com/v0/b/spotify-83a8a.appspot.com/o/images%2Flogo.jpg?alt=media&token=05e4b1a7-790f-4dbd-ac2e-f99fcbd2239f');
        $("#full_name").html(currentUser.full_name)
        function calculateTimeDifference(targetTime) {
            // Get the current time
            const currentTime = new Date();

            // Convert targetTime to a Date object
            const targetDateTime = new Date(targetTime);

            // Calculate the difference in milliseconds
            const difference = currentTime - targetDateTime;
            const days = Math.floor(difference / (1000 * 60 * 60 * 24));

            const hours = Math.floor(difference / (1000 * 60 * 60));
            const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((difference % (1000 * 60)) / 1000);
            if (days > 0) {
                return `${days} d`
            } else if (hours > 0) {
                return `${hours} h`
            } else {
                return `${minutes} m`
            }
        }
        function getConversation() {
            fetch(`http://127.0.0.1:8080/api/v1/conversations/${currentUser.id}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },

            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((response) => {
                    let data = response.data
                    let conversation_id = data[0].conversation_id
                    $(".chat-area").attr("conversation_id", conversation_id)
                    let other_user = data[0].other_user
                    let content = ""
                    const maxLength = 25;

                    data.forEach(function (value) {
                        let time = calculateTimeDifference(value.last_message_created_at)
                        let message = value.last_message_content
                        if (message.length > maxLength) {
                            message = message.substring(0, maxLength) + '...'
                        }
                        content += `<div class="msg online" data-conversation_id="${value.conversation_id}">
                            <img class="msg-profile"
                                src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSkPNpVyCfLq4Ojgvjb5cQppb0DtLAcopVaQmgTikpKpA&s" alt="" />
                            <div class="msg-detail">
                                <div class="msg-username">${value.other_user.full_name}</div>
                                <div class="msg-content">
                                    <span class="msg-message">${message}</span>
                                    <span class="msg-date">${time}</span>
                                </div>
                            </div>
                        </div>`
                    })
                    $(".conversation-area").html(content)
                    getMessage(conversation_id, other_user)

                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }
        function getMessage(conversation_id) {
            fetch(`http://127.0.0.1:8080/api/v1/conversations/${conversation_id}/messages`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },

            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((response) => {
                    let data = response.messages
                    $(".chat-area-title").html(data.full_name)
                    $(".chat-area-profile").html(data.avatar)
                    let currentUserId = $(".user-profile").attr("data-user_id");

                    let content = ''
                    data.forEach((value) => {
                        if (value.user_id == currentUserId) {
                            content += `<div class="chat-msg owner">
                            <div class="chat-msg-content">
                                <div class="chat-msg-text">${value.content}</div>
                            </div>
                        </div>`
                        } else {
                            content += `<div class="chat-msg">
                            <div class="chat-msg-profile">
                                <img class="chat-msg-img"
                                    src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3364143/download+%2812%29.png"
                                    alt="" />
                            </div>
                            <div class="chat-msg-content">
                                <div class="chat-msg-text">${value.content}</div>
                            </div>
                        </div>`
                        }
                        $(".chat-area-main").html(content)
                        scrollToBottom();
                    });

                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }


        $("#btnLogout").click(() => {
            sessionStorage.removeItem("accessToken");
            sessionStorage.removeItem("refreshToken");
            sessionStorage.removeItem("currentUser");
            window.location.href = `http://127.0.0.1:8080/login`;
        });
        getConversation()


        function sendMessage(content) {
            scrollToBottom()
            let conversation_id = $(".chat-area").attr("conversation_id");
            fetch(`http://127.0.0.1:8080/api/v1/conversations/${conversation_id}/messages`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": Cookies.get("csrftoken"),
                },
                body: JSON.stringify({
                    user_id: $(".user-profile").attr("data-user_id"),
                    content: content,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((response) => {
                    // Process the newly created user data
                    $("#input-text").val("")
                    getConversation()

                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }
        $("#input-text").keyup((e) => {
            let value = $(e.target).val();
            if (e.keyCode == 13) {
                sendMessage(value)
            }
        })

        Pusher.logToConsole = true;

        var pusher = new Pusher('ef136162ebafbc149f55', {
            cluster: 'mt1'
        });

        var channel = pusher.subscribe('my-channel');
        channel.bind('my-event', function (data) {
            scrollToBottom()
            getMessage(1, 2)
        });
        function scrollToBottom() {
            var chatArea = $('.chat-area');
            chatArea.scrollTop(chatArea.prop("scrollHeight"));
        }
        scrollToBottom();
        $(".conversation-area").on("click", ".msg", function (e) {
            // Your event handling code here
            let conversation_id = $(this).attr("data-conversation_id");
            $(".chat-area").attr("conversation_id", conversation_id)
            getMessage(conversation_id)
        });
    </script>
</body>

</html>